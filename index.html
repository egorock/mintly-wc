<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mintly WalletConnect v3</title>

  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- ethers.js (–º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –ø–æ–∑–∂–µ, —Å–µ–π—á–∞—Å –ø–æ—á—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg1: #f8faff;
      --bg2: #e6ebf2;
      --primary: #007bff;
      --primary-dark: #0056b3;
      --text-main: #111827;
      --text-muted: #6b7280;
      --card-bg: #ffffffdd;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 8px 10px 14px;
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: flex-start;
    }

    .wrapper {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      padding: 10px 10px 12px;
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      white-space: nowrap;
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      font-size: 14px;
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: 0.18s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }

    button:hover {
      background: var(--primary-dark);
    }

    button:disabled {
      opacity: 0.65;
      cursor: default;
    }

    .btn-secondary {
      background: #eef2ff;
      color: #4338ca;
    }

    .btn-secondary:hover {
      background: #e0e7ff;
    }

    .hidden {
      display: none !important;
    }

    .status-row {
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      min-height: 18px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #cbd5f5;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: none;
      flex-shrink: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .log-box {
      margin-top: 4px;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 11px;
      color: #374151;
      max-height: 90px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .log-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .log-content {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (max-width: 400px) {
      .wrapper {
        padding: 8px 8px 10px;
        border-radius: 10px;
      }
      h1 {
        font-size: 16px;
      }
      .subtitle {
        font-size: 11px;
      }
      button {
        font-size: 13px;
        padding: 9px 10px;
      }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="header">
      <div class="title-box">
        <h1>Mintly WalletConnect</h1>
        <p class="subtitle">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</p>
      </div>
      <div class="pill">BSC Testnet ¬∑ v3</div>
    </div>

    <div class="buttons-row">
      <button id="connectBtn">
        üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫
      </button>
      <button id="sendBtn" class="hidden">
        üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
      </button>
      <button id="explorerBtn" class="btn-secondary hidden">
        üîç –í —Å–∫–∞–Ω–µ—Ä
      </button>
    </div>

    <div class="status-row">
      <div id="spinner" class="spinner"></div>
      <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è‚Ä¶</div>
    </div>

    <div class="log-box">
      <div class="log-label">–°—Ç–∞—Ç—É—Å</div>
      <div id="log" class="log-content"></div>
    </div>
  </div>

  <script type="module">
    // –ù–µ–±–æ–ª—å—à–æ–π shim –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞—é—Ç process.env
    window.process = { env: { NODE_ENV: "production" } };

    import SignClient from "./vendor/walletconnect/wc-sdk.js";
    import { WalletConnectModal } from "./vendor/walletconnect/walletconnect-modal.js";

    const { ethers } = window;

    // Telegram WebApp
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      // –ú–æ–∂–Ω–æ —á—É—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Ñ–æ–Ω –≤ Telegram-—Ç–µ–º–µ
      tg.setBackgroundColor("#f8faff");
    }

    const REQUIRED_CHAIN = "eip155:1115511"; 
    const REQUIRED_CHAIN_ID = 11155111;

    const projectId = "304ab24704c29b3d89ab4001b3eab9aa";
    const relayUrl = "wss://relay.walletconnect.com";

    const modal = new WalletConnectModal({
      projectId,
      themeMode: "light",
    });

    let client = null;
    let session = null;
    let lastTxHash = null;

    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const spinnerEl = document.getElementById("spinner");

    const connectBtn = document.getElementById("connectBtn");
    const sendBtn = document.getElementById("sendBtn");
    const explorerBtn = document.getElementById("explorerBtn");

    // üîí –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–æ–≥
    const log = (msg) => {
      console.log(msg);

      const safePrefixes = [
        "WalletConnect initialized",
        "Session established",
        "Sending transaction...",
        "TX hash:"
      ];

      if (safePrefixes.some(p => msg.startsWith(p))) {
        logEl.textContent += msg + "\n";
      }
    };

    const setStatus = (text, { loading = false } = {}) => {
      statusEl.textContent = text;
      spinnerEl.style.display = loading ? "inline-block" : "none";
    };

    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    const getAccountInfo = () => {
      if (!session) return null;
      const entry = session.namespaces.eip155.accounts[0]; // "eip155:97:0x..."
      const [_, chainIdStr, address] = entry.split(":");
      return { chainIdStr, address };
    };

    // === 1) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ ===
    connectBtn.onclick = async () => {
      try {
        setStatus("üü° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect‚Ä¶", { loading: true });
        log("WalletConnect initialized");

        client = await SignClient.init({ projectId, relayUrl });

        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction", "personal_sign"],
              events: ["accountsChanged", "chainChanged"],
              chains: [REQUIRED_CHAIN],
            },
          },
        });

        if (uri) {
          modal.openModal({ uri });
        }

        session = await approval();
        modal.closeModal();

        log("Session established");

        const info = getAccountInfo();
        if (!info) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞");

        const short = info.address.slice(0, 6) + "..." + info.address.slice(-4);
        setStatus(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${short}`, { loading: false });

        connectBtn.classList.add("hidden");
        sendBtn.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        setStatus("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è", { loading: false });

        if (tg) {
          tg.sendData(JSON.stringify({
            type: "tx_result",
            status: "error",
            error: "connect_error: " + err.message
          }));
        }
      }
    };

    // === 2) –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ===
    sendBtn.onclick = async () => {
      try {
        if (!session) {
          throw new Error("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫");
        }

        const info = getAccountInfo();
        if (!info) throw new Error("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏");

        if (info.chainIdStr !== String(REQUIRED_CHAIN_ID)) {
          if (info.chainIdStr === "1") {
            // –ò–∑–≤–µ—Å—Ç–Ω—ã–π –±–∞–≥ ‚Äî –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç 1, –Ω–æ —Ç—Ä–∞–Ω–∑–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —É—Ö–æ–¥–∏—Ç –≤ –Ω—É–∂–Ω—É—é —Å–µ—Ç—å
            console.warn("WalletConnect reported chainId=1, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º‚Ä¶");
          } else {
            throw new Error(`–ö–æ—à–µ–ª—ë–∫ —Å–æ–æ–±—â–∞–µ—Ç chainId=${info.chainIdStr}. –û–∂–∏–¥–∞–µ—Ç—Å—è 97 (BSC Testnet).`);
          }
        }

        const u = new URL(window.location.href);
        const to = u.searchParams.get("to");
        let data = u.searchParams.get("data") || "";
        data = decodeURIComponent(data);
        const valueStr = u.searchParams.get("value") || "0";

        if (!to || !data) {
          throw new Error("–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (to / data)");
        }

        if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
          throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è");
        }

        if (!data.startsWith("0x") || data.length % 2 !== 0) {
          throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏");
        }

        if (!/^\d+$/.test(valueStr)) {
          throw new Error("value –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º");
        }

        const valueWei = BigInt(valueStr);
        const valueHex = "0x" + valueWei.toString(16);

        const tx = {
          from: info.address,
          to,
          data,
          value: valueHex,
          gasLimit: "0x2dc6c0", // –ª–∏–º–∏—Ç, –≥–∞–∑ –≤—ã–±–µ—Ä–µ—Ç –∫–æ—à–µ–ª—ë–∫
        };

        setStatus("‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏‚Ä¶", { loading: true });
        log("Sending transaction...");

        await sleep(600);

        const txHash = await client.request({
          topic: session.topic,
          chainId: REQUIRED_CHAIN,
          request: {
            method: "eth_sendTransaction",
            params: [tx],
          },
        });

        lastTxHash = txHash;
        log("TX hash: " + txHash);
        setStatus("üü¢ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞", { loading: false });

        sendBtn.classList.add("hidden");
        explorerBtn.classList.remove("hidden");

        // –û—Ç–¥–∞—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram-–±–æ—Ç
        if (tg) {
          tg.sendData(JSON.stringify({
            type: "tx_result",
            status: "success",
            txHash: txHash
          }));
          // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã—Ç—å WebApp
          tg.close();
        }
      } catch (err) {
        console.error(err);
        setStatus("‚ö†Ô∏è " + err.message, { loading: false });

        if (tg) {
          tg.sendData(JSON.stringify({
            type: "tx_result",
            status: "error",
            error: "tx_error: " + err.message
          }));
          tg.close();
        }
      }
    };

    // === 3) –û—Ç–∫—Ä—ã—Ç—å –≤ —Å–∫–∞–Ω–µ—Ä–µ ===
    explorerBtn.onclick = () => {
      if (!lastTxHash) return;
      window.open(`https://testnet.bscscan.com/tx/${lastTxHash}`, "_blank");
    };
  </script>
</body>
</html>